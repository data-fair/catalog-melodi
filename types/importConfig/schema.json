{
  "$id": "https://github.com/data-fair/catalog-melodi/import-config",
  "x-exports": [
    "schema"
  ],
  "title": "ImportConfig",
  "type": "object",
  "additionalProperties": false,
  "required": [
    "geoLevel",
    "pivotConcepts",
    "columnsToKeep"
  ],
  "properties": {
    "geoLevel": {
      "title": "Spatial Resolution",
      "x-i18n-title": {
        "fr": "Niveau géographique"
      },
      "description": "Select the geographic level to import",
      "x-i18n-description": {
        "fr": "Sélectionnez le niveau géographique à importer"
      },
      "type": "string",
      "layout": {
        "comp": "autocomplete",
        "getItems": {
          "url": "https://api.insee.fr/melodi/catalog/${context.resourceId}",
          "itemsResults": "data.spatialResolution",
          "itemTitle": "item.label.find(l => l.lang === 'fr' || l.lang === 'FR')?.content || item.id",
          "itemKey": "item.id",
          "itemValue": "item.id"
        }
      }
    },
    "columnsToKeep": {
      "title": "Columns to keep",
      "description": "Select the dimensions to include in the file.",
      "x-i18n-title": { "fr": "Colonnes à conserver" },
      "x-i18n-description": { "fr": "Sélectionnez les dimensions à inclure dans le fichier." },
      "type": "array",
      "uniqueItems": true,
      "default": ["TIME_PERIOD"], 
      "items": { "type": "string" },
      "minItems": 1,
      "layout": {
        "comp": "autocomplete",
        "getItems": {
          "url": "https://api.insee.fr/melodi/range/${context.resourceId}",
          "itemsResults": "(data.range || []).filter(i => i.concept)",
          "itemTitle": "(item.concept.label && item.concept.label.en) || item.concept.code",
          "x-i18n-itemTitle": { "fr": "(item.concept.label && item.concept.label.fr) || item.concept.code" },
          "itemKey": "item.concept.code",
          "itemValue": "item.concept.code"
        }
      }
    },
    "pivotConcepts": {
      "title": "Pivot Dimensions",
      "description": "Select concepts to transform into columns. The values will be combined (Cross-tabulation).",
      "x-i18n-title": { "fr": "Dimensions à croiser" },
      "x-i18n-description": { "fr": "Sélectionnez les concepts à transformer en colonnes. Les valeurs seront combinées (Tableau croisé)." },
      "type": "array",
      "minItems": 1,
      "layout": {
        "if": "!!parent.data?.columnsToKeep",
        "comp": "autocomplete",
        "getItems": {
          "url": "https://api.insee.fr/melodi/range/${context.resourceId}#${(parent.data.columnsToKeep || []).length}",
          "itemsResults": "(data.range || []).filter(item => (item.values || []).length < 15 && item.concept && !(parent.data.columnsToKeep || []).includes(item.concept.code))",
          "itemTitle": "(item.concept.label && item.concept.label.en) + ' (Ex: ' + (item.values || []).slice(0, 3).map(v => v.label.en).join(', ') + '...)'",
          "x-i18n-itemTitle": { "fr": "(item.concept.label && item.concept.label.fr) + ' (Ex: ' + (item.values || []).slice(0, 3).map(v => v.label.fr).join(', ') + '...)'" },
          "itemKey": "item.concept.code",
          "itemValue": "item.concept.code"
        }
      },
      "items": {
        "type": "string"
      }
    },
    "filters": {
      "title": "Filters",
      "type": "array",
      "layout": {
        "density": "comfortable"
      },
      "x-i18n-title": {
        "fr": "Filtres"
      },
      "description": "List of filters to apply during the import process.",
      "x-i18n-description": {
        "fr": "Liste des filtres à appliquer lors du processus d'importation."
      },
      "items": {
        "type": "object",
        "title": "Filter",
        "x-i18n-title": {
          "fr": "Filtre"
        },
        "required": [
          "selectedConcept",
          "selectedValues"
        ],
        "properties": {
          "selectedConcept": {
            "type": "string",
            "title": "Concept",
            "description": "Choose a concept from Melodi to filter the imported data.",
            "x-i18n-title": {
              "fr": "Concept"
            },
            "x-i18n-description": {
              "fr": "Choisissez un concept de Melodi pour filtrer les données importées."
            },
            "layout": {
              "comp": "autocomplete",
              "getItems": {
                "url": "https://api.insee.fr/melodi/range/${context.resourceId}",
                "itemsResults": "(data.range || []).filter(item => item.concept && item.concept.code !== 'GEO')",
                "itemTitle": "(item.concept.label && item.concept.label.en) + ' (Ex: ' + (item.values || []).slice(0, 3).map(v => v.label.en).join(', ') + '...)'",
                "x-i18n-itemTitle": { "fr": "(item.concept.label && item.concept.label.fr) + ' (Ex: ' + (item.values || []).slice(0, 3).map(v => v.label.fr).join(', ') + '...)'" },
                "itemKey": "item.concept.code",
                "itemValue": "item.concept.code"
              }
            }
          },
          "selectedValues": {
            "type": "array",
            "title": "Values",
            "x-i18n-title": {
              "fr": "Valeurs"
            },
            "default": [],
            "additionalProperties": true,
            "description": "Values to filter on",
            "x-i18n-description": {
              "fr": "Valeurs à filtrer"
            },
            "minItems": 1,
            "layout": {
              "props": {
                "clearable": true
              },
              "if": "!!parent.data?.selectedConcept",
              "comp": "autocomplete",
              "getItems": {
                "url": "https://api.insee.fr/melodi/range/${context.resourceId}",
                "itemsResults": "((data.range || []).find(c => c.concept && c.concept.code === parent.data.selectedConcept)?.values || [])",
                "itemTitle": "item.label.en",
                "x-i18n-itemTitle": {
                  "fr": "item.label.fr"
                },
                "itemKey": "item.code",
                "itemValue": "item.id || item.code"
              }
            },
            "items": {
              "type": "string"
            }
          }
        }
      }
    },
    "useDatasetTitle": {
      "title": "Use remote dataset title",
      "x-i18n-title": {
        "fr": "Utiliser le titre du jeu de données distant"
      },
      "description": "If enabled, the imported dataset will use the title of the remote dataset instead of the title of the remote distribution.",
      "x-i18n-description": {
        "fr": "Si activé, le jeu de données importé utilisera le titre du jeu de données distant au lieu du titre de la distribution distante."
      },
      "type": "boolean",
      "default": true,
      "layout": {
        "comp": "switch",
        "cols": 12
      }
    }
  },
  "layout": {
    "title": null
  }
}